<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>16宮格拼圖 2.0版本</title>
    <link rel="stylesheet" href="stylesheets/style.css">
</head>
<body>
    <button id="random">打亂一波</button>
    <div id="all">

    </div>


    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
    <script>
        var allX, allY, xPixel, yPixel; 
        var canMoveClass, whitePuzzleClass;
        var isWin;
        var isNotInRandom;
        mainFunction();



        function mainFunction() {
            setDefaultValue();
            setDefaultSetting();
            setRandomButtonClick();
            setMoveItems();
            
        }

        function setDefaultSetting() {
            setDefaultSize();
            setDefaultClass();
            setDefaultBox();
        }

        function setMoveItems() {
            setWhoCanMove();
            setCanMoveBoxOnclick();
        }

        function setRandomButtonClick() {
            document.getElementById("random").addEventListener("click",
            RandomButtonClickEvent
            );
        }

        function RandomButtonClickEvent() {
            var event = new MouseEvent("click",
            canMoveClickEvent);

            var randomTurn = Math.floor( Math.random() * 51 + 50);//50-100 

            isNotInRandom = false;
            while(randomTurn > 0) {
                var randomCanMoveIndex = Math.floor( Math.random() * document.getElementsByClassName(canMoveClass).length);
                document.getElementsByClassName(canMoveClass)[randomCanMoveIndex].dispatchEvent(event);
                randomTurn --;
            }
            isNotInRandom = true;
            
        }

        function setDefaultValue() {
            isWin = false;
            isNotInRandom = true;
        }

        function setDefaultSize() {
            allX = 4;
            allY = 4;
            xPixel = 600;
            yPixel = 600;   
        }

        function setDefaultClass() {
            canMoveClass = "canMove";
            // cantMoveClass = "cantMove";
            whitePuzzleClass = "pic0";
        }

        function setDefaultBox() {
            for (var j = 0; j<allY; j++){
                var row = document.createElement("div");
                row.classList.add("row","row"+j);
            
                for (var i = 0; i<allX; i++) {
                    var column = document.createElement("div");
                    column.classList.add("single", "pic"+(j*allX+i));
                    column.setAttribute("id", (j*allX+i) );
                    row.appendChild(column);
                }
                document.getElementById("all").appendChild(row);
            }
        }

        function removeWhoCanMove() {
            while(document.getElementsByClassName(canMoveClass).length>0) {
                // document.getElementsByClassName(canMoveClass)[0].classList.add(cantMoveClass);
                document.getElementsByClassName(canMoveClass)[0].classList.remove(canMoveClass);
           }
        }

        function setWhoCanMove() {
            var whitePlaceId = document.getElementsByClassName(whitePuzzleClass)[0].id;
            var whitePlaceIdNum = parseInt(whitePlaceId) ;
            // var whiteRow = Math.floor(whitePlaceId[whitePlaceId.length-1] / allX);
            // var whiteCol = Math.floor(whitePlaceId[whitePlaceId.length-1] % allX);
            
            removeWhoCanMove();   
            
            var topIdNum = whitePlaceIdNum - allX;
            var buttomIdNum = whitePlaceIdNum + allX;
            var leftIdNum = whitePlaceIdNum - 1;
            var rightIdNum = whitePlaceIdNum + 1;

            var aroundArray = new Array(topIdNum, buttomIdNum, leftIdNum, rightIdNum);
            aroundArray.forEach( function(item) {
                if(document.getElementById(item) != null) {
                    
                    document.getElementById(item).classList.add(canMoveClass);
                }
            });
            
            
        }

        function removeAllBoxOnclick() {
            var allBox = document.getElementsByClassName("single");
            for(var index = 0; index<allBox.length; index++) {
                allBox[index].removeEventListener("click",
                canMoveClickEvent);
            };
        }

        function setCanMoveBoxOnclick() {
            removeAllBoxOnclick();
            var canMoveBox = document.getElementsByClassName(canMoveClass);
            for(var index = 0; index<canMoveBox.length; index++) {
                canMoveBox[index].addEventListener("click",
                canMoveClickEvent);
            };
        }

        function canMoveClickEvent() {
            var beforeWhiteBox = document.getElementsByClassName(whitePuzzleClass)[0];

            if(isNotInRandom){
                moveAnimate(this);
            };
            
            

            beforeWhiteBox.classList.replace(beforeWhiteBox.classList[1], this.classList[1]);
            this.classList.replace(this.classList[1], whitePuzzleClass);
            setMoveItems();
            
            

            if (isNotInRandom) {
                checkWin();
                if (isWin) {
                    whenWinDoing();
                }
            }
        }

        function moveAnimate(clickItem) {
            var whiteBox = document.getElementsByClassName(whitePuzzleClass)[0];
            
            var temporarilyWhite1 = document.createElement("div");
            temporarilyWhite1.setAttribute("id", "tempo1");
            temporarilyWhite1.setAttribute("style", "background:white; z-index:1;\
            width:" + xPixel/allX + "px; height:" + yPixel/allY + "px;");

            var temporarilyWhite2 = document.createElement("div");
            temporarilyWhite2.setAttribute("id", "tempo2");
            temporarilyWhite2.setAttribute("style", "background:white; z-index:1;\
            width:" + xPixel/allX + "px; height:" + yPixel/allY + "px;");

            var animateBox = document.createElement("div");
            animateBox.classList.add(clickItem.classList[1]);
            animateBox.setAttribute("id", "animate")
            animateBox.setAttribute("style", "z-index:2; position: absolute;");

            // temporarilyWhite1.appendChild(animateBox);
            clickItem.appendChild(animateBox);

            clickItem.appendChild(temporarilyWhite1);
            whiteBox.appendChild(temporarilyWhite2);

           

            var removeBox = function() {
                    document.getElementById("tempo1").remove();
                    animateBox.remove();
                    document.getElementById("tempo2").remove();
                    // clickItem.removeChild(document.getElementById("tempo1"));
                    // clickItem.removeChild(animateBox);
                    // whiteBox.removeChild(document.getElementById("tempo2"));
                
            };

            switch(whereIsIt(clickItem, whiteBox)) {
                case "top":
                    $(animateBox).animate({bottom: yPixel/allY + "px"},150, removeBox);
                    break;
                case "bottom":
                    $(animateBox).animate({top: yPixel/allY + "px"},150, removeBox);
                    break;
                case "left":
                    $(animateBox).animate({right: xPixel/allX + "px"},150, removeBox);
                    break;
                case "right":
                    $(animateBox).animate({left: xPixel/allX + "px"},150, removeBox);
                    break;
                    
            }

            // need promise
            // clickItem.removeChild(document.getElementById("tempo1"));
            // clickItem.removeChild(animateBox);
            // whiteBox.removeChild(document.getElementById("tempo2"));
            // clickItem.removeChild(animateBox);


        }

        function whereIsIt(target, findThis) {
            var targetId = parseInt(target.id);
            var findthisId = parseInt(findThis.id);

            switch(findthisId) {
                case targetId - allX:
                    return "top";
                case targetId + allX:
                    return "bottom";
                case targetId + 1:
                    return "right";
                case targetId - 1:
                    return "left";
            }
            return "error";
        }

        function checkWin() {
            var all = document.getElementsByClassName("single");
            isWin = true;
            for(var i = 0; i<all.length; i++) {
                var picClassNum = all[i].classList[1].replace("pic", "");
                if (picClassNum != all[i].id) {
                    isWin = false;
                    break;
                }
            }

        }

        function whenWinDoing() {
            alert("還原成功！");
        }
    </script>
    
</body>
</html>